package twolovers.exploitfixer.bungee.commands;

import net.md_5.bungee.api.CommandSender;
import net.md_5.bungee.api.chat.TextComponent;
import net.md_5.bungee.api.connection.ProxiedPlayer;
import net.md_5.bungee.api.plugin.Command;
import twolovers.exploitfixer.bungee.ExploitFixer;
import twolovers.exploitfixer.bungee.managers.ExploitPlayerManager;
import twolovers.exploitfixer.bungee.managers.ModuleManager;
import twolovers.exploitfixer.bungee.modules.MessagesModule;
import twolovers.exploitfixer.bungee.modules.NotificationsModule;

import java.util.Locale;

public class ExploitFixerCommand extends Command {
	private MessagesModule messagesModule;
	private NotificationsModule notificationsVariables;
	private ExploitPlayerManager exploitPlayerManager;

	public ExploitFixerCommand(final String string, final String[] aliases, final ModuleManager moduleManager) {
		super(string, null, aliases);
		this.messagesModule = moduleManager.getMessagesModule();
		this.notificationsVariables = moduleManager.getNotificationsModule();
		this.exploitPlayerManager = moduleManager.getExploitPlayerManager();
	}

	@Override
	public void execute(final CommandSender commandSender, final String[] args) {
		String lang = "en";
		final int length = args.length;

		if (commandSender instanceof ProxiedPlayer) {
			final Locale locale = ((ProxiedPlayer) commandSender).getLocale();

			if (locale != null)
				lang = locale.toLanguageTag().substring(0, 2);
		}

		if (length < 1 || args[0].equals("help")) {
			commandSender
					.sendMessage(new TextComponent(messagesModule.getHelp(lang).replace("%command%", "exploitfixer")));
		} else if (args[0].equals("reload"))
			if (commandSender.hasPermission("exploitfixer.admin")) {
				ExploitFixer.getInstance().reload();
				commandSender.sendMessage(new TextComponent(messagesModule.getReload(lang)));
			} else
				commandSender.sendMessage(new TextComponent(messagesModule.getPermission(lang)));
		else if (args[0].equals("stats"))
			if (commandSender.hasPermission("exploitfixer.admin"))
				commandSender.sendMessage(new TextComponent(messagesModule.getStats(lang)
						.replace("%players_punished%", String.valueOf(exploitPlayerManager.getPunishments()))
						.replace("%players_cached%", String.valueOf(exploitPlayerManager.getSize()))));
			else
				commandSender.sendMessage(new TextComponent(messagesModule.getPermission(lang)));
		else if (args[0].equalsIgnoreCase("notifications")) {
			if (commandSender instanceof ProxiedPlayer) {
				if (commandSender.hasPermission("exploitfixer.admin")
						|| commandSender.hasPermission("exploitfixer.notifications")) {
					final ProxiedPlayer proxiedPlayer = (ProxiedPlayer) commandSender;

					if (!notificationsVariables.isNotifications(proxiedPlayer)) {
						notificationsVariables.setNotifications(proxiedPlayer, true);
						commandSender.sendMessage(new TextComponent(messagesModule.getEnable(lang)));
					} else {
						notificationsVariables.setNotifications(proxiedPlayer, false);
						commandSender.sendMessage(new TextComponent(messagesModule.getDisable(lang)));
					}
				} else
					commandSender.sendMessage(new TextComponent(messagesModule.getPermission(lang)));
			} else
				commandSender.sendMessage(new TextComponent(messagesModule.getConsole(lang)));
		} else
			commandSender.sendMessage(new TextComponent(messagesModule.getUnknown(lang)));
	}
}
