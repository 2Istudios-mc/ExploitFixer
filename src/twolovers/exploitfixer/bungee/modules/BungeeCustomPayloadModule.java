package twolovers.exploitfixer.bungee.modules;

import com.google.common.base.Charsets;
import net.md_5.bungee.api.connection.Connection;
import net.md_5.bungee.api.connection.ProxiedPlayer;
import net.md_5.bungee.api.event.PluginMessageEvent;
import net.md_5.bungee.api.plugin.Plugin;
import net.md_5.bungee.config.Configuration;
import twolovers.exploitfixer.bungee.instanceables.BungeeViolations;
import twolovers.exploitfixer.interfaces.instanceables.ExploitPlayer;
import twolovers.exploitfixer.interfaces.instanceables.Violations;
import twolovers.exploitfixer.interfaces.managers.ModuleManager;
import twolovers.exploitfixer.interfaces.modules.CustomPayloadModule;

import java.util.HashMap;
import java.util.Map;

public class BungeeCustomPayloadModule implements CustomPayloadModule {
	private Map<String, Double> multipliers = new HashMap<>();
	private Plugin plugin;
	private ModuleManager moduleManager;
	private Violations violations;
	private int maxChannelsAmount, bigDataMaxBytes;
	private double cancelVls, reduceVls, maxChannelsVls, bigDataVls;
	private boolean enabled;

	public BungeeCustomPayloadModule(final Plugin plugin, final ModuleManager moduleManager, final Object configYml) {
		this.plugin = plugin;
		this.moduleManager = moduleManager;

		reload(configYml);
	}

	@Override
	public double getCancelVls() {
		return cancelVls;
	}

	@Override
	public double getReduceVls() {
		return reduceVls;
	}

	@Override
	public Violations getViolations() {
		return violations;
	}

	@Override
	public String getName() {
		return "CustomPayload";
	}

	@Override
	final public boolean isEnabled() {
		return enabled;
	}

	@Override
	public void reload(final Object configYml) {
		final Configuration configYml1 = (Configuration) configYml;
		final Configuration configurationSection = configYml1.getSection("custompayload.multipliers");
		final String name = getName().toLowerCase();

		this.enabled = configYml1.getBoolean("custompayload.enabled");
		this.cancelVls = configYml1.getDouble("custompayload.cancel_vls");
		this.reduceVls = configYml1.getDouble(name + ".reduce_vls");
		this.violations = new BungeeViolations(configYml1.getSection("custompayload.violations"));
		this.maxChannelsVls = configYml1.getDouble(name + ".invalid.max_channels.vls");
		this.maxChannelsAmount = configYml1.getInt(name + ".invalid.max_channels.amount");
		this.bigDataVls = configYml1.getDouble(name + ".invalid.big_data.vls");
		this.bigDataMaxBytes = configYml1.getInt(name + ".invalid.big_data.max_bytes");

		for (final String key : configurationSection.getKeys())
			multipliers.put(key, configurationSection.getDouble(key));
	}

	@Override
	public void check(final Object event) {
		if (event instanceof PluginMessageEvent) {
			final PluginMessageEvent pluginMessageEvent = (PluginMessageEvent) event;
			final Connection sender = pluginMessageEvent.getSender();

			if (sender instanceof ProxiedPlayer && sender.isConnected()) {
				final String tag = pluginMessageEvent.getTag();

				if (tag != null) {
					final String content = new String(pluginMessageEvent.getData(), Charsets.UTF_8);
					final ProxiedPlayer proxiedPlayer = (ProxiedPlayer) sender;
					final ExploitPlayer exploitPlayer = moduleManager.getExploitPlayerManager().get(proxiedPlayer.getUniqueId(), proxiedPlayer);

					if (tag.toLowerCase().endsWith("register") && exploitPlayer.addChannels(content.split("[\u0001-\u0009]").length) > maxChannelsAmount) {
						exploitPlayer.addVls(plugin, event, sender, this, multipliers.getOrDefault("MAX_CHANNELS", maxChannelsVls));
					} else if (content.length() > bigDataMaxBytes) {
						exploitPlayer.addVls(plugin, event, sender, this, multipliers.getOrDefault(tag, bigDataVls));
					} else {
						exploitPlayer.addVls(plugin, event, sender, this, multipliers.getOrDefault(tag, multipliers.getOrDefault("OTHER", 1D)));
					}
				} else
					pluginMessageEvent.setCancelled(true);
			}
		}
	}
}
