package twolovers.exploitfixer.bukkit.managers;

import org.bukkit.Bukkit;
import org.bukkit.Server;
import org.bukkit.entity.Player;
import twolovers.exploitfixer.bukkit.instanceables.BukkitExploitPlayer;
import twolovers.exploitfixer.interfaces.instanceables.ExploitPlayer;
import twolovers.exploitfixer.interfaces.managers.ExploitPlayerManager;
import twolovers.exploitfixer.interfaces.managers.ModuleManager;

import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.UUID;
import java.util.logging.Level;

public class BukkitExploitPlayerManager implements ExploitPlayerManager {
	final private ModuleManager moduleManager;
	final private Map<UUID, ExploitPlayer> exploitPlayers = new HashMap<>();
	private int punishments = 0;

	BukkitExploitPlayerManager(final ModuleManager moduleManager) {
		this.moduleManager = moduleManager;

		reload();
	}

	@Override
	public ExploitPlayer get(final UUID uuid) {
		ExploitPlayer exploitPlayer = exploitPlayers.getOrDefault(uuid, null);

		if (exploitPlayer == null) {
			final Player player = Bukkit.getPlayer(uuid);

			exploitPlayer = new BukkitExploitPlayer(player.getName(), moduleManager);
			exploitPlayers.put(uuid, exploitPlayer);
		}

		return exploitPlayer;
	}

	@Override
	public void clear() {
		final Server server = Bukkit.getServer();
		final Iterator<UUID> iterator = exploitPlayers.keySet().iterator();
		boolean cleared = false;

		while (iterator.hasNext()) {
			final UUID uuid = iterator.next();

			if (server.getPlayer(uuid) == null) {
				iterator.remove();
				cleared = true;
			}
		}

		if (cleared) {
			server.getLogger().log(Level.INFO, "[ExploitFixer] Cleared unused cached players!");
		}
	}

	@Override
	public void reload() {
		exploitPlayers.clear();
	}

	@Override
	public int getSize() {
		return exploitPlayers.size();
	}

	@Override
	public int getPunishments() {
		return punishments;
	}

	@Override
	public int addPunishment() {
		return ++punishments;
	}
}
