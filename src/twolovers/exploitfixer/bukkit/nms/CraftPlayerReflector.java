package twolovers.exploitfixer.bukkit.nms;

import org.bukkit.entity.Player;

import java.lang.reflect.Field;
import java.lang.reflect.Method;

public class CraftPlayerReflector {
	private final Player player;
	private Object playerConnection = null;

	public CraftPlayerReflector(final Player player) {
		this.player = player;
	}

	private Object getPlayerConnection() {
		if (playerConnection == null)
			try {
			final Method getHandle = player.getClass().getMethod("getHandle");
			final Object nmsPlayer = getHandle.invoke(player);
			final Field conField = nmsPlayer.getClass().getField("playerConnection");
			playerConnection = conField.get(nmsPlayer);
			} catch (final Exception e) {
				e.printStackTrace();
			}

			return playerConnection;
	}

	public void closeChannel() {
		try {
			final Object playerConnection = getPlayerConnection();
			final Field netField = playerConnection.getClass().getField("networkManager");
			final Object net = netField.get(playerConnection);
			final Field chanField = net.getClass().getField("channel");
			final Object chan = chanField.get(net);
			final Method method = chan.getClass().getMethod("closeFuture");

			method.invoke(chan);
		} catch (final Exception e) {
			e.printStackTrace();
		}
	}

	public void disconnectChannel(final String kickMessage) {
		try {
			final Object playerConnection = getPlayerConnection();
			final Method method = playerConnection.getClass().getMethod("disconnect", String.class);

			method.invoke(playerConnection, kickMessage);
		} catch (final Exception e) {
			e.printStackTrace();
		}
	}
}
