package twolovers.exploitfixer.bukkit.modules;

import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.reflect.StructureModifier;
import com.comphenix.protocol.wrappers.WrappedBlockData;
import com.comphenix.protocol.wrappers.nbt.NbtBase;
import io.netty.buffer.ByteBuf;
import org.bukkit.configuration.ConfigurationSection;
import org.bukkit.configuration.file.YamlConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.plugin.Plugin;
import twolovers.exploitfixer.bukkit.instanceables.BukkitThresholds;
import twolovers.exploitfixer.bukkit.utils.VersionUtil;
import twolovers.exploitfixer.interfaces.instanceables.ExploitPlayer;
import twolovers.exploitfixer.interfaces.instanceables.Thresholds;
import twolovers.exploitfixer.interfaces.managers.ModuleManager;
import twolovers.exploitfixer.interfaces.modules.PacketsModule;

import java.util.HashMap;
import java.util.Map;

public class BukkitPacketsModule implements PacketsModule {
	private final Plugin plugin;
	private final ModuleManager moduleManager;
	private final Map<String, Double> multipliers = new HashMap<>();
	private Thresholds thresholds;
	private boolean enabled, offline;
	private int bigData, blockDig, blockPlace, setCreativeSlot, windowClick, cancelVls, reduceVls;

	public BukkitPacketsModule(final Plugin plugin, final ModuleManager moduleManager, final Object configYml) {
		this.plugin = plugin;
		this.moduleManager = moduleManager;
		reload(configYml);
	}

	final public void reload(final Object configYml) {
		final YamlConfiguration configYml1 = (YamlConfiguration) configYml;
		final ConfigurationSection configurationSection = configYml1.getConfigurationSection("packets.multipliers");
		final String name = getName().toLowerCase();

		this.enabled = configYml1.getBoolean(name + ".enabled");
		this.cancelVls = configYml1.getInt(name + ".cancel_vls");
		this.reduceVls = configYml1.getInt(name + ".reduce_vls");
		this.bigData = configYml1.getInt(name + ".big_data");
		this.offline = configYml1.getBoolean(name + ".offline");
		this.windowClick = configYml1.getInt(name + ".window_click");
		this.blockPlace = configYml1.getInt(name + ".block_place");
		this.blockDig = configYml1.getInt(name + ".block_dig");
		this.setCreativeSlot = configYml1.getInt(name + ".set_creative_slot");
		this.thresholds = new BukkitThresholds(configYml1.getConfigurationSection(name + ".thresholds"));

		for (final String key : configurationSection.getKeys(false))
			multipliers.put(key, configurationSection.getDouble(key));
	}

	@Override
	public double getMultiplier(final String packetName) {
		return multipliers.getOrDefault(packetName, 1D);
	}

	@Override
	public boolean isEnabled() {
		return enabled;
	}

	@Override
	public void checkPacket(final Object packetEvent, final String packetName) {
		final PacketEvent event = (PacketEvent) packetEvent;
		final Player player = event.getPlayer();
		ExploitPlayer exploitPlayer = null;

		if (player != null && player.isOnline()) {
			final String playerName = player.getName();
			exploitPlayer = moduleManager.getExploitPlayerManager().get(playerName);

			if (exploitPlayer != null)
				exploitPlayer.addVls(plugin, event, player, this, getMultiplier(packetName));
		}

		if (!event.isCancelled() && bigData > 0) {
			final PacketContainer packet = event.getPacket();
			final StructureModifier<ItemStack> itemModifier = packet.getItemModifier();
			final StructureModifier<WrappedBlockData> blockDataModifier = packet.getBlockData();
			final StructureModifier<Long> longs = packet.getLongs();
			final StructureModifier<String> strings = packet.getStrings();
			final StructureModifier<NbtBase<?>> nbtModifier = packet.getNbtModifier();
			int packetSize = 0;

			if (itemModifier.size() > 50 || blockDataModifier.size() > 50 || longs.size() > 50 || strings.size() > 50 || nbtModifier.size() > 50) {
				if (exploitPlayer != null) {
					exploitPlayer.addVls(plugin, event, player, this, bigData);
				}
			} else {
				for (final ItemStack itemStack : itemModifier.getValues()) {
					if (itemStack != null) {
						int dataBytes = itemStack.getData().toString().getBytes().length;

						if (itemStack.hasItemMeta()) {
							final ItemMeta itemMeta = itemStack.getItemMeta();
							try {
								dataBytes += itemMeta.toString().getBytes().length;
							} catch (final NullPointerException e) {
								dataBytes += String.valueOf(itemMeta).getBytes().length;
							}
						}

						packetSize += dataBytes;
					}
				}

				for (final WrappedBlockData blockData : blockDataModifier.getValues()) {
					if (blockData != null) {
						int dataBytes = blockData.toString().getBytes().length;

						packetSize += dataBytes;
					}
				}

				for (final String string : strings.getValues()) {
					if (string != null) {
						int dataBytes = string.getBytes().length;

						packetSize += dataBytes;
					}
				}

				for (final NbtBase<?> nbtBase : nbtModifier.getValues()) {
					if (nbtBase != null) {
						int dataBytes = nbtBase.getValue().toString().length();

						packetSize += dataBytes;
					}
				}

				if (!VersionUtil.isOneDotSeven()) {
					final StructureModifier<ByteBuf> byteBufModifier = packet.getSpecificModifier(ByteBuf.class);

					for (final ByteBuf byteBuf : byteBufModifier.getValues()) {
						if (byteBuf != null)
							packetSize += byteBuf.capacity();
					}
				}

				if (packetSize > 16000) {
					if (exploitPlayer != null) {
						exploitPlayer.addVls(plugin, event, player, this, bigData);
					} else
						event.setCancelled(true);
				}
			}
		}
	}

	@Override
	public int getWindowClick() {
		return windowClick;
	}

	@Override
	public boolean isOffline() {
		return offline;
	}

	@Override
	public int getSetCreativeSlot() {
		return setCreativeSlot;
	}

	@Override
	public int getBlockDig() {
		return blockDig;
	}

	@Override
	public int getBlockPlace() {
		return blockPlace;
	}

	@Override
	public String getName() {
		return "Packets";
	}

	@Override
	public int getCancelVls() {
		return cancelVls;
	}

	@Override
	public int getReduceVls() {
		return reduceVls;
	}

	public Thresholds getThresholds() {
		return thresholds;
	}
}
