package twolovers.exploitfixer.bukkit.adapters;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.reflect.StructureModifier;
import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.PlayerInventory;
import org.bukkit.plugin.Plugin;
import twolovers.exploitfixer.interfaces.managers.ModuleManager;
import twolovers.exploitfixer.interfaces.modules.PacketsModule;

public class BlockDigPacketAdapter extends PacketAdapter {
	private final PacketsModule packetsModule;

	public BlockDigPacketAdapter(final Plugin plugin, final ModuleManager moduleManager) {
		super(plugin, PacketType.Play.Client.BLOCK_DIG);
		this.packetsModule = moduleManager.getPacketsModule();
	}

	@Override
	public void onPacketReceiving(final PacketEvent event) {
		if (!event.isCancelled() && packetsModule.isEnabled()) {
			final Player player = event.getPlayer();

			if (player != null) {
				final StructureModifier<ItemStack> itemModifier = event.getPacket().getItemModifier();

				if (itemModifier != null && itemModifier.size() > 0) {
					final ItemStack itemUse = itemModifier.read(0);

					if (itemUse != null) {
						final PlayerInventory playerInventory = player.getInventory();
						ItemStack itemOnHand = playerInventory.getItem(playerInventory.getHeldItemSlot());

						if (itemOnHand == null)
							itemOnHand = new ItemStack(Material.AIR);

						if (packetsModule.isBlockDig() && (!itemUse.isSimilar(itemOnHand) && itemUse.hasItemMeta() && itemUse.getItemMeta().toString().length() > 256))
							event.setCancelled(true);
					}
				}
			} else if (packetsModule.isOffline())
				event.setCancelled(true);
		}
	}
}