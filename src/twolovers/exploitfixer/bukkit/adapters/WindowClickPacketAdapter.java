package twolovers.exploitfixer.bukkit.adapters;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.reflect.StructureModifier;
import org.bukkit.inventory.InventoryView;
import org.bukkit.plugin.Plugin;
import twolovers.exploitfixer.interfaces.managers.ModuleManager;
import twolovers.exploitfixer.interfaces.modules.ItemsModule;
import twolovers.exploitfixer.interfaces.modules.PacketsModule;
import twolovers.exploitfixer.shared.enums.Identity;

public class WindowClickPacketAdapter extends PacketAdapter {
	private final PacketsModule packetsModule;
	private final ItemsModule itemsModule;

	public WindowClickPacketAdapter(final Plugin plugin, final ModuleManager moduleManager) {
		super(plugin, PacketType.Play.Client.WINDOW_CLICK);
		this.packetsModule = moduleManager.getPacketsModule();
		this.itemsModule = moduleManager.getItemsModule();
	}

	@Override
	public void onPacketReceiving(final PacketEvent event) {
		packetsModule.checkPacket(event, Identity.WINDOW_CLICK);

		if (itemsModule.isEnabled()) {
			final StructureModifier<Integer> integers = event.getPacket().getIntegers();
			final InventoryView inventoryView = event.getPlayer().getOpenInventory();

			if (inventoryView != null && integers.size() > 0) {
				final int slot = integers.read(1);
				final int maxSlots = inventoryView.countSlots();

				if (slot > maxSlots)
					event.setCancelled(true);
			}
		}
	}
}