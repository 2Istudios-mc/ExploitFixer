package twolovers.exploitfixer.bukkit.commands;

import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import twolovers.exploitfixer.bukkit.ExploitFixer;
import twolovers.exploitfixer.bukkit.utils.VersionUtil;
import twolovers.exploitfixer.bukkit.managers.ExploitPlayerManager;
import twolovers.exploitfixer.bukkit.managers.ModuleManager;
import twolovers.exploitfixer.bukkit.modules.MessagesModule;
import twolovers.exploitfixer.bukkit.modules.NotificationsModule;

public class ExploitFixerCommand implements CommandExecutor {
	private MessagesModule messagesModule;
	private NotificationsModule notificationsModule;
	private ExploitPlayerManager exploitPlayerManager;

	public ExploitFixerCommand(final ModuleManager moduleManager) {
		this.messagesModule = moduleManager.getMessagesModule();
		this.notificationsModule = moduleManager.getNotificationsModule();
		this.exploitPlayerManager = moduleManager.getExploitPlayerManager();
	}

	@Override
	public boolean onCommand(final CommandSender commandSender, final Command command, final String label,
			final String[] args) {
		final int length = args.length;
		String lang = "en";

		if (commandSender instanceof Player)
			if (VersionUtil.isOneDotFifteen()) {
				final String locale = ((Player) commandSender).getLocale();

				if (locale != null)
					lang = locale.substring(0, 2);
			} else {
				final String locale = ((Player) commandSender).spigot().getLocale();

				if (locale != null)
					lang = locale.substring(0, 2);
			}

		if (length < 1 || args[0].equals("help")) {
			commandSender.sendMessage(messagesModule.getHelp(lang).replace("%command%", label));
		} else if (args[0].equals("reload"))
			if (commandSender.hasPermission("exploitfixer.admin")) {
				ExploitFixer.getInstance().reload();
				commandSender.sendMessage(messagesModule.getReload(lang));
			} else
				commandSender.sendMessage(messagesModule.getPermission(lang));
		else if (args[0].equals("stats"))
			if (commandSender.hasPermission("exploitfixer.admin"))
				commandSender.sendMessage(messagesModule.getStats(lang)
						.replace("%players_punished%", String.valueOf(exploitPlayerManager.getPunishments()))
						.replace("%players_cached%", String.valueOf(exploitPlayerManager.getSize())));
			else
				commandSender.sendMessage(messagesModule.getPermission(lang));
		else if (args[0].equalsIgnoreCase("notifications")) {
			if (commandSender instanceof Player) {
				if (commandSender.hasPermission("exploitfixer.admin")
						|| commandSender.hasPermission("exploitfixer.notifications")) {
					final Player player = (Player) commandSender;

					if (!notificationsModule.isNotifications(player)) {
						notificationsModule.setNotifications(player, true);
						commandSender.sendMessage(messagesModule.getEnable(lang));
					} else {
						notificationsModule.setNotifications(player, false);
						commandSender.sendMessage(messagesModule.getDisable(lang));
					}
				} else
					commandSender.sendMessage(messagesModule.getPermission(lang));
			} else
				commandSender.sendMessage(messagesModule.getConsole(lang));
		} else
			commandSender.sendMessage(messagesModule.getUnknown(lang));

		return true;
	}
}
