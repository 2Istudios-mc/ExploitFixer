package dev._2lstudios.exploitfixer.bungee.managers;

import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.UUID;

import dev._2lstudios.exploitfixer.bungee.exploit.BungeeExploitPlayer;
import net.md_5.bungee.api.ProxyServer;
import net.md_5.bungee.api.connection.ProxiedPlayer;

public class ExploitPlayerManager {
	private final ProxyServer server;
	private final ModuleManager moduleManager;
	private final Map<UUID, BungeeExploitPlayer> exploitPlayers = new HashMap<>();
	private int punishments = 0;

	ExploitPlayerManager(final ProxyServer server, final ModuleManager moduleManager) {
		this.server = server;
		this.moduleManager = moduleManager;

		reload();
	}

	public BungeeExploitPlayer get(final UUID uuid, final ProxiedPlayer player) {
		BungeeExploitPlayer exploitPlayer = exploitPlayers.getOrDefault(uuid, null);

		if (exploitPlayer == null) {
			exploitPlayer = new BungeeExploitPlayer(server, player.getName(), moduleManager);
			exploitPlayers.put(uuid, exploitPlayer);
		}

		return exploitPlayer;
	}

	public void reload() {
		exploitPlayers.clear();

		for (final ProxiedPlayer player : server.getPlayers()) {
			final BungeeExploitPlayer exploitPlayer = get(player.getUniqueId(), player);

			exploitPlayer.setLogged(true);
		}
	}

	public void clear() {
		final Iterator<UUID> iterator = exploitPlayers.keySet().iterator();
		boolean cleared = false;

		while (iterator.hasNext()) {
			final UUID uuid = iterator.next();

			if (server.getPlayer(uuid) == null) {
				iterator.remove();
				cleared = true;
			}
		}

		if (cleared) {
			moduleManager.getNotificationsModule().debug("[ExploitFixer] Cleared unused cached players!");
		}
	}

	public int getSize() {
		return exploitPlayers.size();
	}

	public int getPunishments() {
		return punishments;
	}

	public int addPunishment() {
		return punishments += 1;
	}
}
