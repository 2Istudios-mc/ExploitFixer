package dev._2lstudios.exploitfixer.bungee;

import java.util.concurrent.TimeUnit;
import java.util.logging.Logger;

import dev._2lstudios.exploitfixer.bungee.commands.ExploitFixerCommand;
import dev._2lstudios.exploitfixer.bungee.configuration.BungeeConfiguration;
import dev._2lstudios.exploitfixer.bungee.listeners.ListenerInitializer;
import dev._2lstudios.exploitfixer.bungee.managers.ExploitPlayerManager;
import dev._2lstudios.exploitfixer.bungee.managers.ModuleManager;
import dev._2lstudios.exploitfixer.bungee.utils.ConfigurationUtil;
import dev._2lstudios.exploitfixer.shared.configuration.IConfiguration;
import net.md_5.bungee.api.plugin.Plugin;
import net.md_5.bungee.api.plugin.PluginManager;
import net.md_5.bungee.api.scheduler.TaskScheduler;

public class ExploitFixer extends Plugin {
	private static ExploitFixer exploitFixer;
	private ConfigurationUtil configurationUtil;
	private ModuleManager moduleManager;
	private ListenerInitializer listenerInitializer;

	@Override
	public void onEnable() {
		final TaskScheduler scheduler = getProxy().getScheduler();

		this.configurationUtil = new ConfigurationUtil(this);

		createConfigurations();

		final IConfiguration configYml = new BungeeConfiguration(
				configurationUtil.getConfiguration("%datafolder%/config.yml"));
		final IConfiguration messagesYml = new BungeeConfiguration(
				configurationUtil.getConfiguration("%datafolder%/messages.yml"));

		exploitFixer = this;
		moduleManager = new ModuleManager(this);
		moduleManager.reload(configYml, messagesYml);
		listenerInitializer = new ListenerInitializer(this, moduleManager);

		register();

		scheduler.schedule(this, () -> {
			final ExploitPlayerManager exploitPlayerManager = moduleManager.getExploitPlayerManager();

			exploitPlayerManager.clear();
		}, 5, 5, TimeUnit.MINUTES);
	}

	@Override
	public void onDisable() {
		final TaskScheduler scheduler = getProxy().getScheduler();

		scheduler.cancel(this);
	}

	public void reload() {
		final ConfigurationUtil configurationUtil = new ConfigurationUtil(this);

		createConfigurations();

		final IConfiguration configYml = new BungeeConfiguration(
				configurationUtil.getConfiguration("%datafolder%/config.yml"));
		final IConfiguration messagesYml = new BungeeConfiguration(
				configurationUtil.getConfiguration("%datafolder%/messages.yml"));

		moduleManager.reload(configYml, messagesYml);

		register();
	}

	private void createConfigurations() {
		configurationUtil.createConfiguration("%datafolder%/config.yml");
		configurationUtil.createConfiguration("%datafolder%/messages.yml");
	}

	private void register() {
		final Logger logger = getLogger();
		final PluginManager pluginManager = getProxy().getPluginManager();

		pluginManager.unregisterCommands(this);
		pluginManager.registerCommand(this,
				new ExploitFixerCommand("exploitfixer", new String[] { "ef" }, moduleManager));

		logger.info("Successfully registered commands!");

		if (this.listenerInitializer.isRegistered()) {
			this.listenerInitializer.unregister();
		}

		this.listenerInitializer.register();

		logger.info("Successfully registered listeners!");
	}

	public static ExploitFixer getInstance() {
		return exploitFixer;
	}
}