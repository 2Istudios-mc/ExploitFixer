package dev._2lstudios.exploitfixer.bungee.instanceables;

import net.md_5.bungee.api.ProxyServer;
import net.md_5.bungee.api.chat.TextComponent;
import net.md_5.bungee.api.connection.ProxiedPlayer;
import net.md_5.bungee.api.plugin.Cancellable;
import net.md_5.bungee.api.plugin.Plugin;
import dev._2lstudios.exploitfixer.bungee.instanceables.ExploitPlayer;
import dev._2lstudios.exploitfixer.bungee.managers.ExploitPlayerManager;
import dev._2lstudios.exploitfixer.bungee.managers.ModuleManager;
import dev._2lstudios.exploitfixer.bungee.modules.MessagesModule;
import dev._2lstudios.exploitfixer.bungee.modules.NotificationsModule;
import dev._2lstudios.exploitfixer.shared.interfaces.Module;
import dev._2lstudios.exploitfixer.shared.interfaces.ViolationModule;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.URL;
import java.net.URLConnection;
import java.util.*;

public class ExploitPlayer {
	final private ExploitPlayerManager exploitPlayerManager;
	final private MessagesModule messagesModule;
	final private NotificationsModule notificationsModule;
	final private Map<ViolationModule, Double> violations = new HashMap<>();
	final private String name;
	private String onlineUUID = null;
	private boolean logged = false;
	private int channels = 0;
	private double lastViolation = 0;

	public ExploitPlayer(final String name, final ModuleManager moduleManager) {
		this.exploitPlayerManager = moduleManager.getExploitPlayerManager();
		this.messagesModule = moduleManager.getMessagesModule();
		this.notificationsModule = moduleManager.getNotificationsModule();
		this.name = name;
	}

	public void clearChannels() {
		this.channels = 0;
	}

	public int addChannels(final int channels) {
		return this.channels += channels;
	}

	public double getViolations(final Module module) {
		if (module instanceof ViolationModule) {
			return violations.getOrDefault(module, 0D);
		} else {
			return 0D;
		}
	}

	public String getOnlineUUID() {
		if (onlineUUID == null) {
			try {
				final URLConnection connection = new URL("https://api.mojang.com/users/profiles/minecraft/" + name)
						.openConnection();

				connection.setDoOutput(true);
				connection.connect();

				final BufferedReader bufferedReader = new BufferedReader(
						new InputStreamReader(connection.getInputStream()));
				final StringBuilder response = new StringBuilder();

				String inputLine;

				while ((inputLine = bufferedReader.readLine()) != null)
					response.append(inputLine).append("\n");

				bufferedReader.close();
				onlineUUID = response.toString();
			} catch (Exception ignored) {
			}
		}

		return onlineUUID;
	}

	public void addVls(final Plugin plugin, final Object event, final ProxiedPlayer player,
			final ViolationModule module, final double amount) {
		if (player.isConnected()) {
			final Violations violations = (Violations) module.getViolations();

			if (violations != null) {
				final ProxyServer server = plugin.getProxy();
				final double currentTime = System.currentTimeMillis();
				final Locale locale = player.getLocale();
				String lang = null;

				if (currentTime - lastViolation >= 1000) {
					lastViolation = currentTime;

					for (final ViolationModule violationModule : new HashSet<>(this.violations.keySet())) {
						final double vls = this.violations.get(violationModule) - violationModule.getReduceVls();

						if (vls <= 0)
							this.violations.remove(violationModule);
						else
							this.violations.put(violationModule, vls);
					}
				}

				final double oldVls = getViolations(module);
				final double newVls = oldVls + amount;

				if (locale != null)
					lang = locale.toString().substring(0, 2);

				final String kickMessage = messagesModule.getKickMessage(module, lang);

				this.violations.put(module, newVls);

				if (event instanceof Cancellable && module.getCancelVls() <= newVls)
					((Cancellable) event).setCancelled(true);

				for (final int threshold : violations.getViolations()) {
					if (threshold > oldVls && threshold <= newVls) {
						final Collection<String> commands = violations.getCommands(threshold);

						if (commands != null && !commands.isEmpty()) {
							for (final String punishCommand : commands) {
								if (!punishCommand.isEmpty()) {
									if (punishCommand.equals("kick")) {
										player.disconnect(new TextComponent(kickMessage));
										exploitPlayerManager.addPunishment();
									} else if (punishCommand.equals("notification")) {
										notificationsModule.sendNotification(module.getName(), player, (int) newVls);
									} else {
										server.getPluginManager().dispatchCommand(server.getConsole(),
												punishCommand.replace("%player%", player.getName()));
									}
								}
							}
						}
					}
				}
			}
		} else if (event instanceof Cancellable) {
			((Cancellable) event).setCancelled(true);
		}
	}

	public void clearViolations() {
		violations.clear();
	}

	public void setLogged(final boolean logged) {
		this.logged = logged;
	}

	public boolean isLogged() {
		return logged;
	}
}
