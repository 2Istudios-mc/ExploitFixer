package dev._2lstudios.exploitfixer.bukkit.commands;

import org.bukkit.ChatColor;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import dev._2lstudios.exploitfixer.bukkit.ExploitFixer;
import dev._2lstudios.exploitfixer.bukkit.utils.VersionUtil;
import dev._2lstudios.exploitfixer.bukkit.managers.ExploitPlayerManager;
import dev._2lstudios.exploitfixer.bukkit.managers.ModuleManager;
import dev._2lstudios.exploitfixer.bukkit.modules.MessagesModule;
import dev._2lstudios.exploitfixer.bukkit.modules.NotificationsModule;

public class ExploitFixerCommand implements CommandExecutor {
	private MessagesModule messagesModule;
	private NotificationsModule notificationsModule;
	private ExploitPlayerManager exploitPlayerManager;
	private final boolean hamsterApiEnabled;

	public ExploitFixerCommand(final ModuleManager moduleManager, final boolean hamsterApiEnabled) {
		this.messagesModule = moduleManager.getMessagesModule();
		this.notificationsModule = moduleManager.getNotificationsModule();
		this.exploitPlayerManager = moduleManager.getExploitPlayerManager();
		this.hamsterApiEnabled = hamsterApiEnabled;
	}

	@Override
	public boolean onCommand(final CommandSender commandSender, final Command command, final String label,
			final String[] args) {
		final int length = args.length;
		final String lang;

		if (commandSender instanceof Player) {
			lang = VersionUtil.getLocale((Player) commandSender);
		} else {
			lang = "en";
		}

		if (length < 1 || args[0].equals("help")) {
			commandSender.sendMessage(messagesModule.getHelp(lang).replace("%command%", label));
		} else if (args[0].equals("reload"))
			if (commandSender.hasPermission("exploitfixer.admin")) {
				ExploitFixer.getInstance().reload();
				commandSender.sendMessage(messagesModule.getReload(lang));
			} else
				commandSender.sendMessage(messagesModule.getPermission(lang));
		else if (args[0].equals("stats"))
			if (commandSender.hasPermission("exploitfixer.admin"))
				commandSender.sendMessage(messagesModule.getStats(lang)
						.replace("%players_punished%", String.valueOf(exploitPlayerManager.getPunishments()))
						.replace("%players_cached%", String.valueOf(exploitPlayerManager.getSize())));
			else
				commandSender.sendMessage(messagesModule.getPermission(lang));
		else if (args[0].equalsIgnoreCase("notifications")) {
			if (commandSender instanceof Player) {
				if (commandSender.hasPermission("exploitfixer.admin")
						|| commandSender.hasPermission("exploitfixer.notifications")) {
					final Player player = (Player) commandSender;

					if (!notificationsModule.isNotifications(player)) {
						notificationsModule.setNotifications(player, true);
						commandSender.sendMessage(messagesModule.getEnable(lang));
					} else {
						notificationsModule.setNotifications(player, false);
						commandSender.sendMessage(messagesModule.getDisable(lang));
					}
				} else
					commandSender.sendMessage(messagesModule.getPermission(lang));
			} else
				commandSender.sendMessage(messagesModule.getConsole(lang));
		} else
			commandSender.sendMessage(messagesModule.getUnknown(lang));

		if (!hamsterApiEnabled) {
			commandSender
					.sendMessage(ChatColor.RED + "HamsterAPI is not installed! ExploitFixer will not behave properly!");
		}

		return true;
	}
}
