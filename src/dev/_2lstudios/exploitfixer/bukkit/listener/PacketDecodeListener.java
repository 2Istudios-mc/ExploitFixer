package dev._2lstudios.exploitfixer.bukkit.listener;

import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.plugin.Plugin;

import dev._2lstudios.exploitfixer.bukkit.exploit.BukkitExploitPlayer;
import dev._2lstudios.exploitfixer.bukkit.managers.ExploitPlayerManager;
import dev._2lstudios.exploitfixer.bukkit.managers.ModuleManager;
import dev._2lstudios.exploitfixer.bukkit.modules.BukkitNotificationsModule;
import dev._2lstudios.exploitfixer.shared.modules.PacketsModule;
import dev._2lstudios.hamsterapi.HamsterAPI;
import dev._2lstudios.hamsterapi.events.PacketDecodeEvent;
import dev._2lstudios.hamsterapi.hamsterplayer.HamsterPlayer;
import io.netty.buffer.ByteBuf;

public class PacketDecodeListener implements Listener {
    private final Plugin plugin;
    private final ExploitPlayerManager exploitPlayerManager;
    private final BukkitNotificationsModule notificationsModule;
    private final PacketsModule packetsModule;

    PacketDecodeListener(final Plugin plugin, final ModuleManager moduleManager) {
        HamsterAPI.getInstance().getBufferIO();
        this.plugin = plugin;
        this.exploitPlayerManager = moduleManager.getExploitPlayerManager();
        this.notificationsModule = moduleManager.getNotificationsModule();
        this.packetsModule = moduleManager.getPacketsModule();
    }

    @EventHandler(ignoreCancelled = true, priority = EventPriority.LOWEST)
    public void onPacketReceive(final PacketDecodeEvent event) {
        final HamsterPlayer hamsterPlayer = event.getHamsterPlayer();
        final Player player = hamsterPlayer.getPlayer();

        if (player != null && player.isOnline()) {
            final ByteBuf byteBuf = event.getByteBuf().get();
            final String playerName = player.getName();
            final int dataBytes = packetsModule.getDataBytes(), refCnt = byteBuf.refCnt(),
                    capacity = byteBuf.capacity();

            if (capacity < 0) {
                final double dataVls = packetsModule.getDataVls();
                final String reason = "[Decoder|Data] " + playerName
                        + " sent a packet with invalid capacity! capacity: " + capacity + " Vls: " + dataVls;

                cancelExploit(event, hamsterPlayer, player, reason, dataVls);
            } else if (refCnt < 1) {
                final double dataVls = packetsModule.getDataVls();
                final String reason = "[Decoder|Data] " + playerName + " sent a packet with invalid refCnt! refCnt: "
                        + refCnt + " Vls: " + dataVls;

                cancelExploit(event, hamsterPlayer, player, reason, dataVls);
            } else if (capacity > dataBytes) {
                final double dataVls = packetsModule.getDataVls();
                final String reason = "[Decoder|Data] " + playerName + " sent a packet that exceeds size limit! Max: "
                        + dataBytes + " Vls: " + dataVls;

                cancelExploit(event, hamsterPlayer, player, reason, dataVls);
            }
        } else if (packetsModule.isOffline()) {
            final String reason = "[Decoder|Offline] " + getName(player) + " sent a packet while offline!";

            cancelExploit(event, hamsterPlayer, player, reason, 0);
            hamsterPlayer.closeChannel();
        }
    }

    private String getName(final Player player) {
        if (player == null) {
            return "unknown";
        } else {
            return player.getName();
        }
    }

    private void cancelExploit(final PacketDecodeEvent event, final HamsterPlayer hamsterPlayer, final Player player,
            final String reason, final double vls) {
        notificationsModule.debug(reason);
        event.setCancelled(true);

        if (vls > 0) {
            final BukkitExploitPlayer exploitPlayer = exploitPlayerManager.get(player);

            exploitPlayer.addVls(plugin, event, hamsterPlayer, packetsModule, vls);
        }
    }
}